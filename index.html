<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.svg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Focus Studio</title>
  <meta name="description" content="A responsive, customizable website featuring an analog and digital clock, a Pomodoro timer, dark/light themes, full theme customization, and endlessly generated motivational messages that change every hour." />
  <style>
    :root {
      /* Theme variables (overridable at runtime) */
      --bg: #0b0f15;
      --text: #e8eef9;
      --muted: #90A0B7;
      --card: #121826;
      --border: #1f2a3a;
      --shadow: 0 8px 28px rgba(0,0,0,0.25);
      --accent: #6aa0ff;

      /* Button theming */
      --btn-bg: var(--accent);
      --btn-text: #0c1117;
      --btn-radius: 12px;

      /* Typography */
      --font-base: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Segoe UI Variable", "Noto Sans", "Liberation Sans", sans-serif;
      --font-serif: Georgia, "Times New Roman", Times, serif;
      --font-mono: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
      --font-size: 16px;

      /* Components */
      --ring-bg: conic-gradient(var(--accent) 0%, transparent 0%);
      --container-max: 1200px;
    }

    /* Light / Dark baselines (toggle via body[data-theme]) */
    body[data-theme="light"] {
      --bg: #fbfcff;
      --text: #0b1220;
      --muted: #54607a;
      --card: #ffffff;
      --border: #e7eaf1;
      --shadow: 0 8px 28px rgba(12,17,32,0.08);
      --accent: #2f6bff;
      --btn-bg: var(--accent);
      --btn-text: #ffffff;
    }
    body[data-theme="dark"] {
      --bg: #0b0f15;
      --text: #e8eef9;
      --muted: #90A0B7;
      --card: #121826;
      --border: #1f2a3a;
      --shadow: 0 8px 28px rgba(0,0,0,0.25);
      --accent: #6aa0ff;
      --btn-bg: var(--accent);
      --btn-text: #0c1117;
    }

    /* Reset + base */
    *,*::before,*::after { box-sizing: border-box; }
    html,body { height: 100%; }
    body{
      margin:0;
      font-family:var(--font-base);
      font-size:var(--font-size);
      line-height:1.45;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 16px;
    }

    a { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }

    img, canvas, svg { max-width:100%; height:auto; display:block; }

    /* Layout container */
    .container {
      width:100%;
      max-width:var(--container-max);
      margin:0 auto;
    }

    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(180deg, var(--bg), color-mix(in hsl, var(--bg) 80%, transparent));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
      padding: 8px 0;
    }
    .topbar-inner {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 16px;
      max-width:var(--container-max);
      margin:0 auto;
    }

    .brand { display:flex; gap:12px; align-items:center; font-weight:700; }
    .brand .logo{
      width:36px;
      height:36px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--accent), color-mix(in hsl, var(--accent) 30%, transparent));
      box-shadow: 0 0 0 2px color-mix(in hsl, var(--accent) 60%, transparent), 0 6px 20px color-mix(in hsl, var(--accent) 35%, transparent);
      flex: 0 0 36px;
    }
    .brand-title { font-size:1rem; line-height:1; }
    .brand-sub { color:var(--muted); font-size:.88rem; }

    /* Grid */
    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      margin-top:8px;
    }
    @media (min-width:960px) {
      .grid { grid-template-columns: 1.1fr 0.9fr; grid-auto-rows: 1fr; }
      #motivation { grid-column: 1 / -1; }
    }

    /* Card */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2 { margin:0 0 8px 0; font-size:1.1rem; }
    .subtle { color:var(--muted); font-size:.92rem; }

    /* Controls & buttons */
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .btn {
      border: none;
      background: var(--btn-bg);
      color: var(--btn-text);
      padding: 10px 14px;
      border-radius: var(--btn-radius);
      font-weight: 600;
      cursor: pointer;
      transition: transform .04s ease, filter .15s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,.06), 0 6px 16px color-mix(in hsl, var(--btn-bg) 25%, transparent);
    }
    .btn:hover { filter:brightness(1.05); }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn.secondary { background: color-mix(in hsl, var(--btn-bg) 20%, var(--bg)); color:var(--text); border:1px solid var(--border); box-shadow: none; }
    .btn.ghost { background:transparent; color:var(--text); border:1px dashed var(--border); box-shadow:none; }
    .btn.small { padding:6px 10px; font-size:.9rem; }
    .btn.block { width:100%; display:block; }
    .btn.warn { --warn:#ff6b6b; background:var(--warn); color:#fff; box-shadow:0 6px 16px color-mix(in hsl,var(--warn)40%,transparent); }

    .segmented { display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .segmented button { background:transparent; color:var(--text); border:none; padding:8px 12px; cursor:pointer; font-weight:600; font-size:.95rem; }
    .segmented button.active { background:var(--accent); color:var(--btn-text); }

    /* Clocks layout */
    .clocks { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top:10px; }
    .analog-wrap { width:220px; max-width:40%; min-width:160px; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; }
    .analog-wrap canvas { width:100%; height:100%; display:block; }
    .digital { flex:1 1 40%; min-width:180px; display:flex; flex-direction:column; gap:6px; align-items:flex-start; justify-content:center; }
    .digital-time { font-family:var(--font-mono); font-size:2rem; font-weight:700; letter-spacing:1px; }
    .digital-date { color:var(--muted); font-size:.95rem; }

    .form-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:10px; align-items:center; }

    /* Pomodoro */
    .pomodoro .ring { width:var(--size,220px); height:var(--size,220px); border-radius:999px; display:flex; align-items:center; justify-content:center; margin-bottom:12px; background: conic-gradient(var(--accent) calc(var(--p,0)*1%), transparent 0%); }
    .readout { text-align:center; }
    .big { font-size:2.2rem; font-weight:800; font-family:var(--font-mono); }
    .mode { color:var(--muted); margin-top:6px; }

    .row { display:flex; gap:8px; align-items:center; }

    /* Motivation */
    .motivation-wrap { display:flex; gap:18px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .motivation { font-size:1.05rem; margin:0; color:var(--text); }

    /* Footer */
    footer { max-width:var(--container-max); margin:0 auto; color:var(--muted); font-size:.95rem; padding:8px 0; text-align:center; }

    /* Accessibility focus */
    button:focus, a:focus, input:focus, select:focus { outline: 3px solid color-mix(in hsl, var(--accent) 18%, transparent); outline-offset: 3px; }

    /* Small utilities */
    .pill { background: color-mix(in hsl, var(--card) 85%, transparent); padding:6px 10px; border-radius:999px; border:1px solid var(--border); font-size:.9rem; }
    .kbd { font-family:var(--font-mono); font-size:.85rem; background:rgba(0,0,0,0.08); padding:.15rem .35rem; border-radius:6px; }
  </style>
</head>
<body data-theme="dark">
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="brand-title">Focus Studio</div>
          <div class="brand-sub subtle">Clocks • Pomodoro • Motivation</div>
        </div>
      </div>

      <nav class="controls" aria-label="Theme">
        <div class="segmented" role="tablist" aria-label="Theme mode">
          <button id="btnLight" role="tab" aria-selected="false" title="Light mode">Light</button>
          <button id="btnDark" role="tab" aria-selected="true" class="active" title="Dark mode">Dark</button>
        </div>
      </nav>
    </div>
  </header>

  <main class="container" role="main">
    <div class="grid">
      <!-- Clocks -->
      <section id="clocks" class="card" aria-labelledby="clocks-title">
        <h2 id="clocks-title">Clocks</h2>
        <p class="subtle">Customize an analog and a digital clock. Choose timezone, show seconds, and switch 12/24-hour format.</p>

        <div class="clocks" aria-hidden="false">
          <div class="analog-wrap" aria-hidden="false">
            <canvas id="analog" aria-label="Analog clock" role="img"></canvas>
          </div>

          <div class="digital" aria-live="polite">
            <div class="digital-time" id="digitalTime">00:00:00</div>
            <div class="digital-date" id="digitalDate">Monday, Jan 1</div>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>Clock customization</summary>
          <div class="form-grid" style="margin-top:10px">
            <label>Timezone source
              <select id="clockTzSource">
                <option value="local">Local timezone</option>
                <option value="fixed">Fixed UTC offset</option>
              </select>
            </label>
            <label>UTC offset (hours)
              <input type="number" id="clockTzOffset" min="-12" max="14" step="0.5" value="0" />
            </label>
            <label>Digital format
              <select id="digitalFormat">
                <option value="24">24-hour</option>
                <option value="12">12-hour</option>
              </select>
            </label>
            <label>Show seconds (digital)
              <select id="digitalSeconds">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>Blinking colon (digital)
              <select id="digitalBlink">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>Show date (digital)
              <select id="digitalShowDate">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>Analog: show seconds hand
              <select id="analogSeconds">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>Analog: smooth seconds
              <select id="analogSmooth">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>Analog: show numbers
              <select id="analogNumbers">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </label>
            <label>Analog face
              <input type="color" id="analogFace" value="#0e1524" />
            </label>
            <label>Ticks color
              <input type="color" id="analogTicks" value="#90A0B7" />
            </label>
            <label>Hour hand
              <input type="color" id="analogHour" value="#e8eef9" />
            </label>
            <label>Minute hand
              <input type="color" id="analogMinute" value="#6aa0ff" />
            </label>
            <label>Second hand
              <input type="color" id="analogSecond" value="#ff6b6b" />
            </label>
          </div>
        </details>
      </section>

      <!-- Pomodoro -->
      <section id="pomodoro" class="card" aria-labelledby="pomo-title">
        <h2 id="pomo-title">Pomodoro Timer</h2>
        <p class="subtle">Stay focused with customizable work, short break, and long break intervals. Optional sound, auto start, and notifications.</p>

        <div class="pomodoro">
          <div class="ring" id="pomoRing" aria-hidden="true" style="--p:0; --size:220px;">
            <div class="readout">
              <div class="big" id="pomoTime">25:00</div>
              <div class="mode"><span id="pomoMode">Work</span> • <span id="pomoRound">Round 1</span></div>
            </div>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn" id="pomoStart">Start</button>
            <button class="btn secondary" id="pomoPause">Pause</button>
            <button class="btn secondary" id="pomoReset">Reset</button>
            <button class="btn ghost" id="pomoSkip">Skip</button>
          </div>

          <div class="row" style="margin-bottom:10px;">
            <span class="pill"><strong>Status:</strong> <span id="pomoStatus">Idle</span></span>
            <span class="pill" title="Keyboard shortcut"><span class="kbd">Space</span> to Start/Pause</span>
          </div>

          <details>
            <summary>Timer settings</summary>
            <div class="form-grid" style="margin-top:8px">
              <label>Work (minutes)
                <input type="number" id="pWork" min="1" max="180" value="25" />
              </label>
              <label>Short break (minutes)
                <input type="number" id="pShort" min="1" max="60" value="5" />
              </label>
              <label>Long break (minutes)
                <input type="number" id="pLong" min="1" max="120" value="15" />
              </label>
              <label>Rounds until long break
                <input type="number" id="pRounds" min="1" max="12" value="4" />
              </label>
              <label>Auto start next session
                <select id="pAuto">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </label>
              <label>Sound
                <select id="pSound">
                  <option value="true">On</option>
                  <option value="false">Off</option>
                </select>
              </label>
              <label>Volume
                <input type="range" id="pVolume" min="0" max="1" step="0.05" value="0.5" />

            </div>
          </details>
        </div>
      </section>
    </div>
  </main>

  <footer class="container" role="contentinfo">
    Built for focus and clarity. All features run locally in your browser. No external assets required.
  </footer>

  <script>
    "use strict";

    // Tiny helpers
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from((root || document).querySelectorAll(sel));
    const clamp = (x, min, max) => Math.min(max, Math.max(min, x));

    // Local storage helpers
    const store = {
      get(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch { return fallback; }
      },
      set(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
      }
    };

    // Theme keys & defaults
    const THEME_KEY = "tfs_theme_vars";
    const MODE_KEY = "tfs_theme_mode";

    const defaultLight = {
      bg: "#fbfcff", text: "#0b1220", muted: "#54607a", card: "#ffffff",
      accent: "#2f6bff", btnBg: "#2f6bff", btnText: "#ffffff",
      btnRadius: 12, font: getComputedStyle(document.documentElement).getPropertyValue("--font-base").trim(), fontSize: 16
    };
    const defaultDark = {
      bg: "#0b0f15", text: "#e8eef9", muted: "#90A0B7", card: "#121826",
      accent: "#6aa0ff", btnBg: "#6aa0ff", btnText: "#0c1117",
      btnRadius: 12, font: getComputedStyle(document.documentElement).getPropertyValue("--font-base").trim(), fontSize: 16
    };

    function applyThemeVars(v) {
      const root = document.documentElement.style;
      if (!v) return;
      if (v.bg) root.setProperty("--bg", v.bg);
      if (v.text) root.setProperty("--text", v.text);
      if (v.muted) root.setProperty("--muted", v.muted);
      if (v.card) root.setProperty("--card", v.card);
      if (v.accent) root.setProperty("--accent", v.accent);
      if (v.btnBg) root.setProperty("--btn-bg", v.btnBg);
      if (v.btnText) root.setProperty("--btn-text", v.btnText);
      if (typeof v.btnRadius === "number") root.setProperty("--btn-radius", v.btnRadius + "px");
      if (v.font) root.setProperty("--font-base", v.font);
      if (typeof v.fontSize === "number") root.setProperty("--font-size", v.fontSize + "px");
      ensureButtonContrast();
    }

    function ensureButtonContrast() {
      // Safely compute contrast and pick readable text for buttons if needed.
      try {
        const style = getComputedStyle(document.documentElement);
        const bg = style.getPropertyValue("--btn-bg").trim() || "#6aa0ff";
        const txt = style.getPropertyValue("--btn-text").trim() || "#0c1117";

        const hexToRgb = (hex) => {
          hex = String(hex).trim().replace("#", "");
          if (hex.length === 3) hex = hex.split("").map(c => c + c).join("");
          const n = parseInt(hex, 16);
          return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
        };
        const relLum = ({r,g,b}) => {
          const srgb = [r,g,b].map(v => v/255).map(v => v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4));
          return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
        };

        const bgRGB = hexToRgb(bg.startsWith("#") ? bg : "#6aa0ff");
        const txtRGB = hexToRgb(txt.startsWith("#") ? txt : "#0c1117");
        const L1 = Math.max(relLum(bgRGB), relLum(txtRGB));
        const L2 = Math.min(relLum(bgRGB), relLum(txtRGB));
        const contrast = (L1 + 0.05) / (L2 + 0.05);
        if (contrast < 4.0) {
          const bgLum = relLum(bgRGB);
          const suggested = bgLum > 0.4 ? "#0b0f15" : "#ffffff";
          document.documentElement.style.setProperty("--btn-text", suggested);
        }
      } catch (e) { /* fail silently */ }
    }

    function setMode(mode) {
      document.body.setAttribute("data-theme", mode);
      store.set(MODE_KEY, mode);
      const btnL = $("#btnLight"), btnD = $("#btnDark");
      if (btnL) btnL.classList.toggle("active", mode === "light");
      if (btnD) btnD.classList.toggle("active", mode === "dark");
      if (btnL) btnL.setAttribute("aria-selected", mode === "light");
      if (btnD) btnD.setAttribute("aria-selected", mode === "dark");

      const vars = store.get(THEME_KEY, null);
      if (!vars) {
        const d = mode === "light" ? defaultLight : defaultDark;
        applyThemeVars(d);
      } else {
        applyThemeVars(vars);
      }
    }

    // Initialize mode
    setMode(store.get(MODE_KEY, "dark"));

    // Guarded event binder helper
    const onIf = (sel, ev, fn) => { const el = $(sel); if (el) el.addEventListener(ev, fn); };

    // Theme toggles
    onIf("#btnLight", "click", () => setMode("light"));
    onIf("#btnDark", "click", () => setMode("dark"));

    // Safe binding for optional theme inputs (will only attach if elements exist)
    [
      "varAccent","varBg","varCard","varText","varMuted","varBtnBg","varBtnText","varBtnRadius","varFont","varFontSize"
    ].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", () => {
        // read only the inputs present
        const read = () => ({
          accent: (document.getElementById("varAccent")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--accent").trim(),
          bg: (document.getElementById("varBg")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--bg").trim(),
          card: (document.getElementById("varCard")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--card").trim(),
          text: (document.getElementById("varText")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--text").trim(),
          muted: (document.getElementById("varMuted")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--muted").trim(),
          btnBg: (document.getElementById("varBtnBg")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--btn-bg").trim(),
          btnText: (document.getElementById("varBtnText")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--btn-text").trim(),
          btnRadius: parseInt(document.getElementById("varBtnRadius")?.value || getComputedStyle(document.documentElement).getPropertyValue("--btn-radius").replace("px","") || 12, 10),
          font: (document.getElementById("varFont")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--font-base").trim(),
          fontSize: parseInt(document.getElementById("varFontSize")?.value || getComputedStyle(document.documentElement).getPropertyValue("--font-size").replace("px","") || 16, 10)
        });
        applyThemeVars(read());
      });
    });

    // Protected optional buttons (export/import/save/reset) — attach only if present
    onIf("#btnSaveTheme", "click", () => {
      const read = () => ({
        accent: (document.getElementById("varAccent")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--accent").trim(),
        bg: (document.getElementById("varBg")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--bg").trim(),
        card: (document.getElementById("varCard")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--card").trim(),
        text: (document.getElementById("varText")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--text").trim(),
        muted: (document.getElementById("varMuted")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--muted").trim(),
        btnBg: (document.getElementById("varBtnBg")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--btn-bg").trim(),
        btnText: (document.getElementById("varBtnText")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--btn-text").trim(),
        btnRadius: parseInt(document.getElementById("varBtnRadius")?.value || 12, 10),
        font: (document.getElementById("varFont")?.value) || getComputedStyle(document.documentElement).getPropertyValue("--font-base").trim(),
        fontSize: parseInt(document.getElementById("varFontSize")?.value || 16, 10)
      });
      store.set(THEME_KEY, read());
      ensureButtonContrast();
      flashStatus("Theme saved");
    });

    onIf("#btnResetTheme", "click", () => {
      const mode = store.get(MODE_KEY, "dark");
      const d = mode === "light" ? defaultLight : defaultDark;
      applyThemeVars(d);
      store.set(THEME_KEY, d);
      flashStatus("Theme reset");
    });

    onIf("#btnExport", "click", () => {
      const payload = {
        mode: store.get(MODE_KEY, "dark"),
        theme: store.get(THEME_KEY, null),
        clocks: store.get("tfs_clock_settings", null),
        pomodoro: store.get("tfs_pomodoro_settings", null),
        quotes: store.get("tfs_user_quotes", [])
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "time-focus-studio-settings.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    onIf("#btnImport", "click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.onchange = async () => {
        const file = input.files?.[0];
        if (!file) return;
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          if (data.mode) store.set(MODE_KEY, data.mode);
          if (data.theme) store.set(THEME_KEY, data.theme);
          if (data.clocks) store.set("tfs_clock_settings", data.clocks);
          if (data.pomodoro) store.set("tfs_pomodoro_settings", data.pomodoro);
          if (Array.isArray(data.quotes)) store.set("tfs_user_quotes", data.quotes);
          // Apply everything:
          setMode(store.get(MODE_KEY, "dark"));
          loadClockSettings();
          loadPomodoroSettings();
          renderUserQuotes();
          flashStatus("Settings imported");
        } catch {
          flashStatus("Import failed (invalid file)");
        }
      };
      input.click();
    });

    function flashStatus(text) {
      const pill = document.createElement("div");
      pill.textContent = text;
      pill.style.position = "fixed";
      pill.style.bottom = "18px";
      pill.style.left = "50%";
      pill.style.transform = "translateX(-50%)";
      pill.style.padding = "10px 14px";
      pill.style.border = "1px solid var(--border)";
      pill.style.background = "var(--card)";
      pill.style.color = "var(--text)";
      pill.style.borderRadius = "999px";
      pill.style.boxShadow = "var(--shadow)";
      pill.style.zIndex = 1000;
      document.body.appendChild(pill);
      setTimeout(() => pill.remove(), 1800);
    }

    /* ----------------------------
       Clocks
       ---------------------------- */
    const CLOCK_KEY = "tfs_clock_settings";
    const clockDefaults = {
      tzSource: "local",
      tzOffset: 0,
      digitalFormat: "24",
      digitalSeconds: true,
      digitalBlink: true,
      digitalShowDate: true,
      analogSeconds: true,
      analogSmooth: true,
      analogNumbers: true,
      analogFace: "#0e1524",
      analogTicks: "#90A0B7",
      analogHour: "#e8eef9",
      analogMinute: "#6aa0ff",
      analogSecond: "#ff6b6b"
    };
    let clockSettings = loadClockSettings();

    function loadClockSettings() {
      const saved = store.get(CLOCK_KEY, {});
      const merged = {...clockDefaults, ...saved};
      reflectClockInputs(merged);
      return merged;
    }
    function saveClockSettings() { store.set(CLOCK_KEY, clockSettings); }
    function reflectClockInputs(v) {
      if (!v) return;
      $("#clockTzSource").value = v.tzSource;
      $("#clockTzOffset").value = v.tzOffset;
      $("#digitalFormat").value = v.digitalFormat;
      $("#digitalSeconds").value = String(v.digitalSeconds);
      $("#digitalBlink").value = String(v.digitalBlink);
      $("#digitalShowDate").value = String(v.digitalShowDate);
      $("#analogSeconds").value = String(v.analogSeconds);
      $("#analogSmooth").value = String(v.analogSmooth);
      $("#analogNumbers").value = String(v.analogNumbers);
      $("#analogFace").value = v.analogFace;
      $("#analogTicks").value = v.analogTicks;
      $("#analogHour").value = v.analogHour;
      $("#analogMinute").value = v.analogMinute;
      $("#analogSecond").value = v.analogSecond;
    }

    [
      "clockTzSource","clockTzOffset","digitalFormat","digitalSeconds","digitalBlink","digitalShowDate",
      "analogSeconds","analogSmooth","analogNumbers","analogFace","analogTicks","analogHour","analogMinute","analogSecond"
    ].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", () => {
        const v = clockSettings;
        v.tzSource = $("#clockTzSource").value;
        v.tzOffset = parseFloat($("#clockTzOffset").value);
        v.digitalFormat = $("#digitalFormat").value;
        v.digitalSeconds = $("#digitalSeconds").value === "true";
        v.digitalBlink = $("#digitalBlink").value === "true";
        v.digitalShowDate = $("#digitalShowDate").value === "true";
        v.analogSeconds = $("#analogSeconds").value === "true";
        v.analogSmooth = $("#analogSmooth").value === "true";
        v.analogNumbers = $("#analogNumbers").value === "true";
        v.analogFace = $("#analogFace").value;
        v.analogTicks = $("#analogTicks").value;
        v.analogHour = $("#analogHour").value;
        v.analogMinute = $("#analogMinute").value;
        v.analogSecond = $("#analogSecond").value;
        saveClockSettings();
      });
    });

    function getNowWithOffset() {
      const now = new Date();
      if (clockSettings.tzSource === "local") return now;
      const localOffsetMin = now.getTimezoneOffset();
      const desiredOffsetMin = clockSettings.tzOffset * 60;
      const diff = (desiredOffsetMin + localOffsetMin) * 60000;
      return new Date(now.getTime() + diff);
    }

    // Digital clock updater
    let blinkOn = true;
    function formatDigital(d) {
      let H = d.getHours(), M = d.getMinutes(), S = d.getSeconds();
      let period = "";
      if (clockSettings.digitalFormat === "12") {
        period = H >= 12 ? " PM" : " AM";
        H = H % 12; if (H === 0) H = 12;
      }
      const pad = n => String(n).padStart(2, "0");
      const colon = clockSettings.digitalBlink ? (blinkOn ? ":" : " ") : ":";
      const time = clockSettings.digitalSeconds ? `${pad(H)}${colon}${pad(M)}${colon}${pad(S)}${period}` : `${pad(H)}${colon}${pad(M)}${period}`;
      return time;
    }
    function formatDateLine(d) {
      const opts = { weekday: "long", month: "short", day: "numeric" };
      return d.toLocaleDateString(undefined, opts);
    }
    function tickDigital() {
      const now = getNowWithOffset();
      blinkOn = !blinkOn;
      const elTime = $("#digitalTime"), elDate = $("#digitalDate");
      if (elTime) elTime.textContent = formatDigital(now);
      if (elDate) elDate.textContent = clockSettings.digitalShowDate ? formatDateLine(now) : "";
    }
    setInterval(tickDigital, 500);
    tickDigital();

    /* ----------------------------
       Analog canvas drawing
       ---------------------------- */
    const analogCanvas = $("#analog");
    const ctx = analogCanvas ? analogCanvas.getContext("2d") : null;

    if (analogCanvas && ctx) {
      function resizeAnalog() {
        const rect = analogCanvas.getBoundingClientRect();
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        analogCanvas.width = Math.floor(rect.width * dpr);
        analogCanvas.height = Math.floor(rect.height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      new ResizeObserver(resizeAnalog).observe(analogCanvas);
      resizeAnalog();

      function drawAnalog() {
        const rect = analogCanvas.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        ctx.clearRect(0, 0, w, h);

        const r = Math.min(w, h) / 2 - 8;
        const cx = w / 2, cy = h / 2;

        ctx.save();
        // Face
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fillStyle = clockSettings.analogFace;
        ctx.fill();
        // Bezel
        ctx.lineWidth = 2;
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--border").trim() || "#2a2a2a";
        ctx.stroke();

        // Ticks
        for (let i = 0; i < 60; i++) {
          const angle = (Math.PI * 2) * (i / 60);
          const outer = r - 6;
          const inner = i % 5 === 0 ? outer - 10 : outer - 6;
          ctx.beginPath();
          ctx.lineWidth = i % 5 === 0 ? 3 : 1.5;
          ctx.strokeStyle = clockSettings.analogTicks;
          const sx = cx + Math.cos(angle) * inner;
          const sy = cy + Math.sin(angle) * inner;
          const ex = cx + Math.cos(angle) * outer;
          const ey = cy + Math.sin(angle) * outer;
          ctx.moveTo(sx, sy);
          ctx.lineTo(ex, ey);
          ctx.stroke();
        }

        // Numbers
        if (clockSettings.analogNumbers) {
          ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--text").trim();
          ctx.font = "600 16px " + getComputedStyle(document.documentElement).getPropertyValue("--font-base").trim();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          for (let n = 1; n <= 12; n++) {
            const angle = (Math.PI * 2) * (n / 12) - Math.PI/2;
            const nr = r - 28;
            const nx = cx + Math.cos(angle) * nr;
            const ny = cy + Math.sin(angle) * nr;
            ctx.fillText(String(n), nx, ny);
          }
        }

        // Time math
        const now = getNowWithOffset();
        const ms = now.getMilliseconds();
        const secBase = now.getSeconds() + (clockSettings.analogSmooth ? ms/1000 : 0);
        const minBase = now.getMinutes() + secBase/60;
        const hourBase = (now.getHours() % 12) + minBase/60;

        const hourAngle = (Math.PI * 2) * (hourBase / 12) - Math.PI/2;
        const minAngle = (Math.PI * 2) * (minBase / 60) - Math.PI/2;
        const secAngle = (Math.PI * 2) * (secBase / 60) - Math.PI/2;

        // Hour
        ctx.lineCap = "round";
        ctx.strokeStyle = clockSettings.analogHour;
        ctx.lineWidth = 5.5;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(hourAngle) * (r * 0.52), cy + Math.sin(hourAngle) * (r * 0.52));
        ctx.stroke();

        // Minute
        ctx.strokeStyle = clockSettings.analogMinute;
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(minAngle) * (r * 0.72), cy + Math.sin(minAngle) * (r * 0.72));
        ctx.stroke();

        // Second
        if (clockSettings.analogSeconds) {
          ctx.strokeStyle = clockSettings.analogSecond;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.lineTo(cx + Math.cos(secAngle) * (r * 0.80), cy + Math.sin(secAngle) * (r * 0.80));
          ctx.stroke();
          // tail
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.lineTo(cx - Math.cos(secAngle) * (r * 0.18), cy - Math.sin(secAngle) * (r * 0.18));
          ctx.stroke();
        }

        // hub
        ctx.beginPath();
        ctx.arc(cx, cy, 4.5, 0, Math.PI * 2);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--accent").trim();
        ctx.fill();

        ctx.restore();
        requestAnimationFrame(drawAnalog);
      }
      requestAnimationFrame(drawAnalog);
    }

    /* ----------------------------
       Pomodoro
       ---------------------------- */
    const POMO_KEY = "tfs_pomodoro_settings";
    const pomoDefaults = { work:25*60, short:5*60, long:15*60, rounds:4, auto:true, sound:true, volume:0.5 };
    let pomoSettings = {...pomoDefaults, ...store.get(POMO_KEY, {})};

    function loadPomodoroSettings() {
      pomoSettings = {...pomoDefaults, ...store.get(POMO_KEY, {})};
      if ($("#pWork")) $("#pWork").value = Math.round(pomoSettings.work/60);
      if ($("#pShort")) $("#pShort").value = Math.round(pomoSettings.short/60);
      if ($("#pLong")) $("#pLong").value = Math.round(pomoSettings.long/60);
      if ($("#pRounds")) $("#pRounds").value = pomoSettings.rounds;
      if ($("#pAuto")) $("#pAuto").value = String(pomoSettings.auto);
      if ($("#pSound")) $("#pSound").value = String(pomoSettings.sound);
      if ($("#pVolume")) $("#pVolume").value = String(pomoSettings.volume);
      return pomoSettings;
    }
    loadPomodoroSettings();

    let pomoMode = "work";
    let pomoRound = 1;
    let pomoTotal = pomoSettings.work;
    let pomoRemaining = pomoTotal;
    let pomoTimer = null;
    let pomoRunning = false;
    let lastTick = null;

    function setPomoMode(mode) {
      pomoMode = mode;
      pomoTotal = mode === "work" ? pomoSettings.work : (mode === "short" ? pomoSettings.short : pomoSettings.long);
      pomoRemaining = pomoTotal;
      updatePomoUI();
    }

    function updatePomoUI() {
      const modeEl = $("#pomoMode"), roundEl = $("#pomoRound"), timeEl = $("#pomoTime"), statusEl = $("#pomoStatus"), ring = $("#pomoRing");
      if (modeEl) modeEl.textContent = ({ work:"Work", short:"Short Break", long:"Long Break" })[pomoMode];
      if (roundEl) roundEl.textContent = `Round ${pomoRound}`;
      if (timeEl) timeEl.textContent = formatSeconds(pomoRemaining);
      if (statusEl) statusEl.textContent = pomoRunning ? "Running" : "Paused";
      const progress = 1 - (pomoRemaining / Math.max(1, pomoTotal));
      if (ring) ring.style.setProperty("--p", (progress * 100).toFixed(2));
    }

    function formatSeconds(s) {
      s = Math.max(0, Math.floor(s));
      const m = Math.floor(s/60), sec = s % 60;
      return String(m).padStart(2,"0") + ":" + String(sec).padStart(2,"0");
    }

    function startPomo() {
      if (pomoRunning) return;
      pomoRunning = true;
      lastTick = performance.now();
      if ($("#pomoStatus")) $("#pomoStatus").textContent = "Running";
      pomoTimer = requestAnimationFrame(stepPomo);
    }

    function pausePomo() {
      if (!pomoRunning) return;
      pomoRunning = false;
      if ($("#pomoStatus")) $("#pomoStatus").textContent = "Paused";
      if (pomoTimer) cancelAnimationFrame(pomoTimer);
    }

    function resetPomo() {
      setPomoMode(pomoMode);
      updatePomoUI();
    }

    function skipPomo() { completeSession(); }

    function stepPomo(ts) {
      const dt = (ts - lastTick) / 1000;
      lastTick = ts;
      if (pomoRunning) {
        pomoRemaining -= dt;
        if (pomoRemaining <= 0) {
          pomoRemaining = 0;
          updatePomoUI();
          completeSession();
          return;
        }
        updatePomoUI();
        pomoTimer = requestAnimationFrame(stepPomo);
      }
    }

    function completeSession() {
      pausePomo();
      signalEnd();
      if (pomoMode === "work") {
        if (pomoRound % pomoSettings.rounds === 0) {
          setPomoMode("long");
        } else {
          setPomoMode("short");
        }
      } else {
        pomoRound += 1;
        setPomoMode("work");
      }
      updatePomoUI();
      if (pomoSettings.auto) setTimeout(startPomo, 400);
    }

    function signalEnd() {
      if (pomoSettings.sound) beepPattern(pomoSettings.volume);
      try {
        if ("Notification" in window && Notification.permission === "granted") {
          const title = pomoMode === "work" ? "Break time!" : "Back to work!";
          const body = pomoMode === "work" ? "Great job. Take a breather." : "Let’s focus for the next session.";
          new Notification(title, { body });
        }
      } catch {}
    }

    function beepPattern(vol=0.5) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const play = (t, freq, dur) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = freq;
          o.connect(g);
          g.connect(ctx.destination);
          g.gain.value = vol;
          o.start(ctx.currentTime + t);
          o.stop(ctx.currentTime + t + dur);
        };
        play(0.00, 880, 0.12);
        play(0.17, 660, 0.10);
        play(0.30, 990, 0.14);
        setTimeout(() => ctx.close(), 1200);
      } catch {}
    }

    // Controls binding (guarded)
    onIf("#pomoStart", "click", startPomo);
    onIf("#pomoPause", "click", pausePomo);
    onIf("#pomoReset", "click", resetPomo);
    onIf("#pomoSkip", "click", skipPomo);

    // Keyboard Space toggles Start/Pause
    window.addEventListener("keydown", (e) => {
      if (e.code === "Space" && !e.repeat) {
        // avoid toggling if typing in an input
        const tag = document.activeElement?.tagName;
        if (tag === "INPUT" || tag === "TEXTAREA") return;
        e.preventDefault();
        if (pomoRunning) pausePomo(); else startPomo();
      }
    });

    // Pomodoro settings inputs (guarded)
    const bindIf = (sel, ev, fn) => { const el = $(sel); if (el) el.addEventListener(ev, fn); };
    bindIf("#pWork", "input", () => { pomoSettings.work = clamp(parseInt($("#pWork").value,10)*60, 60, 60*180); store.set(POMO_KEY, pomoSettings); if (pomoMode==="work") resetPomo(); });
    bindIf("#pShort", "input", () => { pomoSettings.short = clamp(parseInt($("#pShort").value,10)*60, 60, 60*60); store.set(POMO_KEY, pomoSettings); if (pomoMode==="short") resetPomo(); });
    bindIf("#pLong", "input", () => { pomoSettings.long = clamp(parseInt($("#pLong").value,10)*60, 60, 60*120); store.set(POMO_KEY, pomoSettings); if (pomoMode==="long") resetPomo(); });
    bindIf("#pRounds", "input", () => { pomoSettings.rounds = clamp(parseInt($("#pRounds").value,10), 1, 12); store.set(POMO_KEY, pomoSettings); });
    bindIf("#pAuto", "input", () => { pomoSettings.auto = $("#pAuto").value === "true"; store.set(POMO_KEY, pomoSettings); });
    bindIf("#pSound", "input", () => { pomoSettings.sound = $("#pSound").value === "true"; store.set(POMO_KEY, pomoSettings); });
    bindIf("#pVolume", "input", () => { pomoSettings.volume = parseFloat($("#pVolume").value); store.set(POMO_KEY, pomoSettings); });

    updatePomoUI();

    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }
    function seededPick(rng, arr) { return arr[Math.floor(rng() * arr.length)]; }
    function generateQuote(seed) {
      const rng = mulberry32(seed);
      if (rng() < 0.30) return seededPick(rng, baseQuotes);
      const u = store.get(QUOTES_KEY, []);
      if (u.length && rng() < 0.15) return seededPick(rng, u);
      const A = seededPick(rng, fragments.openers);
      const B = seededPick(rng, fragments.verbs);
      const C = seededPick(rng, fragments.nouns);
      const D = seededPick(rng, fragments.bridges);
      const E = seededPick(rng, fragments.adjectives);
      const F = seededPick(rng, fragments.values);
      const P = seededPick(rng, fragments.prompts);
      const Z = seededPick(rng, fragments.closers);
      const templates = [
        `${A} ${B} ${C}—${P}. ${Z}`,
        `${A} is ${E} work. Choose ${F}, ${P}. ${Z}`,
        `${A} ${D} ${C}. Stay ${E} and ${P}. ${Z}`,
        `${A} ${B} ${C}. ${Z}`,
        `${A}. ${P}. ${Z}`,
        `${A} is yours—${P}. ${Z}`
      ];
      return seededPick(rng, templates);
    }
    function currentHourSeed() {
      const now = new Date();
      return now.getFullYear()*1e6 + (now.getMonth()+1)*1e4 + now.getDate()*1e2 + now.getHours();
    }
    function updateQuoteByHour(force=false) {
      const hourSeed = currentHourSeed();
      const last = updateQuoteByHour._lastSeed;
      if (force || last !== hourSeed) {
        const q = generateQuote(hourSeed);
        const el = $("#quoteText");
        if (el) el.textContent = q;
        updateQuoteByHour._lastSeed = hourSeed;
      }
    }
    updateQuoteByHour(true);
    setInterval(() => updateQuoteByHour(false), 60*1000);

    function renderUserQuotes() {
      const list = store.get(QUOTES_KEY, []);
      const wrap = $("#userQuotesWrap");
      if (!wrap) return;
      if (!list.length) { wrap.innerHTML = "<em>No custom messages yet.</em>"; return; }
      wrap.innerHTML = "";
      list.forEach((q, i) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "8px";
        row.style.padding = "6px 0";
        const span = document.createElement("span");
        span.style.color = "var(--text)";
        span.textContent = q;
        const del = document.createElement("button");
        del.className = "btn small secondary";
        del.textContent = "Remove";
        del.addEventListener("click", () => {
          const arr = store.get(QUOTES_KEY, []);
          arr.splice(i,1);
          store.set(QUOTES_KEY, arr);
          renderUserQuotes();
          flashStatus("Removed");
        });
        row.appendChild(span);
        row.appendChild(del);
        wrap.appendChild(row);
      });
    }
    renderUserQuotes();

    onIf("#btnShuffle", "click", () => {
      const seed = Math.floor(Math.random()*1e9);
      const el = $("#quoteText");
      if (el) el.textContent = generateQuote(seed);
    });

    onIf("#btnCopy", "click", async () => {
      try {
        await navigator.clipboard.writeText($("#quoteText").textContent.trim());
        flashStatus("Copied to clipboard");
      } catch { flashStatus("Copy failed"); }
    });

    onIf("#btnAddQuote", "click", () => {
      const details = $("#motivation details");
      if (details) details.open = true;
      const input = $("#newQuote");
      if (input) input.focus();
    });

    onIf("#saveQuote", "click", () => {
      const inp = $("#newQuote");
      if (!inp) return;
      const val = inp.value.trim();
      if (!val) return;
      const arr = store.get(QUOTES_KEY, []);
      arr.push(val);
      store.set(QUOTES_KEY, arr);
      inp.value = "";
      renderUserQuotes();
      flashStatus("Saved");
    });

    onIf("#clearQuotes", "click", () => {
      if (!confirm("Clear all your custom messages?")) return;
      store.set(QUOTES_KEY, []);
      renderUserQuotes();
      flashStatus("Cleared");
    });

    // small ui init helpers
    function initOnLoad() {
      // Ensure date visibility toggles the element spacing
      const dateEl = $("#digitalDate");
      if (dateEl) {
        const observer = new MutationObserver(() => {
          dateEl.style.display = clockSettings.digitalShowDate ? "block" : "none";
        });
        observer.observe(dateEl, { childList: true, characterData: true, subtree: true });
      }
    }
    initOnLoad();

    // adapt ring size on resize
    function adaptRingSize() {
      const ring = $("#pomoRing");
      if (!ring) return;
      const w = window.innerWidth;
      const size = w < 360 ? 180 : (w < 420 ? 200 : 220);
      ring.style.setProperty("--size", size + "px");
    }
    window.addEventListener("resize", adaptRingSize);
    adaptRingSize();

  </script>
</body>
</html>
